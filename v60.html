<!doctype html>
<html>
<style>
  .step {
    color: gray;
  }
  .active {
      color: green!important;
    font-style: italic;
  }
 .hidden {
   display: none;
 }
</style>

<div>
Ground coffee: <input id="g" type="number" onchange="setSteps()">
Coffee brewed: <input id="brewedg" type="number" onchange="setCoffeeBrewed()">
</div>

<div class="step hidden" id="ice">Add <span id="iceg"></span> ice, zero scale</div>
<div class="step" id="bloom">Bloom <span id="bloomg"></span> until 0:30</div>
<div class="step" id="pour1">Pour to <span id="pour1g"></span> until 1:15</div>
<div class="step" id="pour2">Pour to <span id="pour2g"></span> until 1:45</div>
<div class="step" id="finish">Let finish</div>
<div>
  <input type="checkbox" id="isice" onChange="setSteps()">
  ice
</div>
<div>
  <button onclick="start()">Start</button>
  <span><span id="time"></span> seconds</span>
</div>

<script>
  let cb;
  function setActive(passed) {

    Array.from(document.querySelectorAll(".step")).forEach(e => e.classList.remove("active"));
    if (passed < 30) {
      document.getElementById("bloom").classList.add("active");
    } else if (passed < 75) {
      document.getElementById("pour1").classList.add("active");
    } else if (passed < 105) {
      document.getElementById("pour2").classList.add("active");
    } else {
      document.getElementById("finish").classList.add("active");
    }
  }

 function setCoffeeBrewed() {
   const brewed = document.getElementById("brewedg");
   const g = document.getElementById("g");
   g.value = Number(brewed.value) * 3 / 50;
   setSteps();
 }

 function setSteps() {
   const g = Number(document.getElementById("g").value);

   const bloom = g * 2;
   const pour2 = g * 50 / 3;
   const pour1 = pour2 * 0.6;

   const brewed = document.getElementById("brewedg");
   brewed.value = pour2;

   const ice = document.getElementById("isice");
   if (!ice.checked) {
     document.getElementById("bloomg").innerHTML = `${Math.round(bloom)}g`;
     document.getElementById("pour1g").innerHTML = `${Math.round(pour1)}g`;
     document.getElementById("pour2g").innerHTML = `${Math.round(pour2)}g`;
     document.getElementById("ice").classList.add("hidden");
   } else {
     const ice = pour2 * 0.33;
     document.getElementById("ice").classList.remove("hidden");
     document.getElementById("iceg").innerHTML = `${Math.round(ice)}g`;
     document.getElementById("bloomg").innerHTML = `${Math.round(bloom)}g`;
     document.getElementById("pour1g").innerHTML = `${Math.round(pour1*0.66)}g`;
     document.getElementById("pour2g").innerHTML = `${Math.round(pour2*0.66)}g`;
   }

   localStorage.g = g;
 }

  function start() {
      const g = Number(document.getElementById("g").value);
      const startTime = Date.now();
      if (cb) { clearInterval(cb); }
      cb = setInterval(() => {
        const ms = Date.now() - startTime;
        const passed = Math.floor(ms / 1000);
	document.getElementById("time").innerHTML = passed;
	setActive(passed);
      }, 100);
  }

 if (localStorage.g && !Number.isNaN(parseInt(localStorage.g))) {
   document.getElementById("g").value = parseInt(localStorage.g);
   setSteps();
 }
</script>
</html>
